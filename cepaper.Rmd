---
title: "Figures for the paper *Who bears the cost of forest conservation?*"
author: "Mahesh Poudyal and James Gibbons"
date: "2 January 2017"
output: html_document
---

```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#load library and functions
library(ggplot2)
library(dplyr)
library(magrittr)
library(sjPlot)
library(sjmisc)
library(tidyr)
library(reshape2)
library(scales)
library(grid)
```

## Opportunity cost estimates from the CE model (NPV)
### Comparing annualised equivalent with total annual income
We get opportunity cost estimates in the form of net present value (NPV) based on the willingness to accept (WTA) choice experiment data. In order to compare these estimates with the total annual household income, we get annualised equivalent of the opportunity costs, using a timeframe of 60 years and a discount rate of 5% (see main paper text, and SI for details).

Since we only have total annual household income for the sub-sample of the households who were part of the second phase of the surveys (i.e., detailed agricultural and off-farm income survey), the total number of households for this analysis is 102 from three sites - Ampahitra (25), Zahamena (36), and Sahavazina (39) - with total annual household income data as well as opportunity costs estimates from choice experiment modelling.

#### Setup required function(s)
```{r eaa_fun, echo=FALSE}
##function for calculating EAA factor (this when multiplied by the NPV OC estimate gives the annualised equivalent)
eaa <- function(t, r) {r/(1-(1+r)^-t)}
```

#### Prepare data
```{r oc_hhinc_data, echo=FALSE}
#read data
oc.df <- read.csv("ceoc_hhinc.csv")

##add a new column with EAA value for current year for 60 year timeframe and discount rate ~ 0%
oc.df$eaa60yr0pc <- oc.df$opp_cost_est*eaa(60,0.00001)
##get eaa60yr0pc as proportion of total hh inc
oc.df$prop1 <- oc.df$eaa60yr0pc/oc.df$usd

##add another column with EAA value for current year for 60 year timeframe and discount rate of 2.5%
oc.df$eaa60yr2p5pc <- oc.df$opp_cost_est*eaa(60,0.025)
##get eaa60yr2p5pc as proportion of total hh inc
oc.df$prop2 <- oc.df$eaa60yr2p5pc/oc.df$usd

##add another column with EAA value for current year for 60 year timeframe and discount rate of 5% 
oc.df$eaa60yr5pc <- oc.df$opp_cost_est*eaa(60,0.05)
##get eaa60yr5pc as proportion of total hh inc
oc.df$prop3 <- oc.df$eaa60yr5pc/oc.df$usd

##subset data columns to be used in plots
oc.df.sub1 <- subset(oc.df,
                    select = c("usd","prop1","prop2","prop3"))

##melt subsetted data for easy plotting against annual household income (usd)
oc.df.sub1.melt <- melt(oc.df.sub1, id="usd")
```

#### Plotting annualised equivalent of opportunity costs against total annual household income

```{r oc_hhinc_plot, echo=FALSE}
oc_hhinc_plot <- ggplot(oc.df.sub1.melt, aes(x=usd, y=value,
                                    colour=variable)) +
            geom_point(alpha=0.9) +
            geom_smooth(method='gam') +
            coord_cartesian(xlim = c(50,500), ylim = c(-.05,3)) +
            xlab("\nTotal annual household income (US$)") +
            ylab("Annualised household opportunity costs as % of total household income\n") +
            scale_x_continuous(breaks = seq(50,500,50)) + 
            scale_y_continuous(breaks = seq(0,3,.5), labels = scales::percent) + 
            scale_colour_discrete(name="Time frame (t) and discount rate (r)",
                 breaks=c("prop1","prop2","prop3"),
                                labels=c(" t = 60 years, r = 0.001%",
                                         " t = 60 years, r = 2.5%",
                                         " t = 60 years, r = 5%")) +
            theme_bw() +
            theme(legend.position=c(.8,.9),
                  legend.background = element_rect(colour = "black"),
                  legend.title = element_text(size = 16),
                  legend.text=element_text(size = 16),
                  axis.title = element_text(size = 16),
                  axis.text = element_text(size = 12),
                  axis.line.x = element_line(colour = "black"),
                  axis.line.y = element_line(colour = "black"))

oc_hhinc_plot <- oc_hhinc_plot + geom_vline(xintercept = 233,
                   linetype = "longdash",
                   colour = "#666666") + 
  annotate("text", x=226, y=2, 
           label="Median hh inc (233 US$)", 
           angle=90,
           size=6)

pdf("oc_hhinc_plot.pdf", width = 11, height = 8)
print(oc_hhinc_plot)
dev.off()

```

### Matrix plot - estimating the percentage (and number) of households with opportunity costs higher than US$120 for all combinations of timeframe and discount rates
The main idea here is to show the percentage (and/or number) of households with annualised equivalent opportunity costs above a specific cut-off within CAZ based on our assumptions on the timeframe and discount rates, and estimated population. In the plot below, we use USD 120 as the cut-off figure for the opportunity cost estimates (annualised equivalent), with shades in the plot showing the percentage of households with estimated opportunity costs (annualised) higher than USD 120 per year, and selected quadrants annotated with total number of households with opportunity costs higher than USD 120 for those combinations of timeframe and discount rates. The data used for this comes from the two CAZ sites - site 1 (Ampahitra) (102) and site 2 (Sahavazina) (94) - so a total sample size of 196 households.

```{r matrix_plot, echo=FALSE}
#data preparation
##read data - opportunity cost estimates (all sites)
oppcost.df <- read.csv("oc_all.csv")

##convert 'teviala2' figures to positive values (opportunity costs)
oppcost.df$opp_cost_est <- -1*oppcost.df$teviala2

##subset CAZ sites data (Ampahitra and Sahavazina)
oc_caz.df <- subset(oppcost.df, site=="Ampahitra" | site=="Sahavazina")

#sequencing the combination of timeframe and discount rates
disc.years <- seq(20, 60, by=5)
disc.rates <- seq(0.001, 5.5, by=0.5)/100

matrix.eaa <- sapply(as.list(disc.years), function(x) sapply(as.list(disc.rates), function(y) eaa(x, y)))

##function to calculate proportion of households greater than critical value
prop.household <- function(x, val=120) {
    tmp <- na.omit(x)
    sum(tmp > val)/length(tmp)
}

## this will give the matrix as percentage of households above the threshold within our sample
matrix.prop <- matrix(sapply(matrix.eaa, function(x) prop.household(x * oc_caz.df$opp_cost_est)), ncol=length(disc.years))*100
## this will give the matrix as number of households above the threshold extrapolated to the whole of CAZ population - rounded to nearest integer
matrix.prop1 <- round(matrix(sapply(matrix.eaa, function(x) prop.household(x * oc_caz.df$opp_cost_est)), ncol=length(disc.years))*8197)

## plotting
require(latticeExtra)
x.scale <- list(at=seq(0,5,0.5), cex=1.2)
y.scale <- list(at=seq(20,60,5), cex=1.2)

mplot1<- levelplot(matrix.prop, 
          row.values=disc.rates*100, 
          column.values=disc.years, 
          aspect="full",
          scales=list(x=x.scale, y=y.scale),
          main=list("Households with estimated opportunity costs > US $120 per year"),
          xlab=list('Discount rate (%)',cex=1.8), 
          ylab=list('Time frame (years)', cex=1.8),
          pretty=TRUE,
          col.regions = grey(100:0/100),
          colorkey=list(labels=list(cex=1.2)),
          legend=list(top=list(fun=grid::textGrob("Percent",y=0,x=1.09))))
mplot1

## annotating the selected quadrants with the number of households for the timeframe-discount rate combination
mplot1 <- mplot1 + layer(panel.text(5, 59, '3555', col="red")) + 
  layer(panel.text(2.5, 59, '2760', col="red")) + 
  layer(panel.text(0,59, '1673', col="red")) + 
  layer(panel.text(5, 40, '3680', col="red")) + 
  layer(panel.text(2.5, 40, '3137', col="red")) + 
  layer(panel.text(0, 40, '2467', col="red")) + 
  layer(panel.text(0, 21, '3555', col="red")) + 
  layer(panel.text(2.5, 21, '3848', col="red")) +
  layer(panel.text(5, 21, '4140', col="red"))

pdf("matrix_plot.pdf", width = 8, height = 8)
print(mplot1)
dev.off()

```


## Panel with carbon value in CAZ, opportunity costs, compensation and number of households affected
Using the key figures from our own estimation and existing data from other sources, we highlight the gap between potential value of carbon sequestered in CAZ protected area, estimated opportunity costs and actual compensation provided, including the recipients' valuation of the compensation. Key figures used are described below:

- *npv_oc_all* (=**2375**): Median opportunity costs (NPV) estimated per household

- *sg_com* (=**120**): Average safeguard compensation expected to be spent per household (Obtained from MEEF/SAPM/CI. 2013. *Etude de faisabilité des Sous-Projets de Compensation des Personnes Affectées par le Projet, Nouvelle Aire Protégée du Corridor Ankeniheny-Zahamena (NAP CAZ)*, Programme Environmental III, Madagascar.)

- *cv_com* (=**79**): Average valuation of the compensation provided to the households in 2015 US$ (estimated from contingent valuation survey with 62 PAP households in *Ampahitra*)

- *elig_hh* (=**3555**): Total number of households estimated in/around CAZ protected area with annual opportunity costs higher than US$120

- *sg_hh* (=**1835**): Total number of households set to receive safeguards compensation (revised from the total initially identified PAPs of 2500) (source: MEEF/SAPM/CI. 2013. *Etude de faisabilité des Sous-Projets de Compensation des Personnes Affectées par le Projet, Nouvelle Aire Protégée du Corridor Ankeniheny-Zahamena (NAP CAZ)*, Programme Environmental III, Madagascar.)

- *comp_hh* (=**823**): Total number of households who had received compensation by the close of Third Environmental Program (source: World Bank. 2016. *Madagascar - Third Environmental Program Support Project*, W.B. Group, World Bank, Washington, D.C. Available at: https://goo.gl/I7VP6q, accessed on 25-10-2016.)

- *full_comp_hh* (=**0**): Total number of households who received compensation covering their opportunity costs

- *carbon* (=**110000000**): Total value of carbon sequestered in CAZ protected area due to avoided deforestation (for ten years), equates to around one million tonnes of CO<sub>2</sub> sequestered per year (source: Rainforest Alliance. 2013. *Reduced Emissions from Deforesation in the Ankeniheny-Zahamena Corridor, Madagascar - Validation Report: VCS Version 3*. Available at: https://goo.gl/Yj0gJV, accessed on 2016-12-06.), and average social cost of per tonne of CO<sub>2</sub> for 2015 at 5% discount rate (USD 11, source: https://www.epa.gov/climatechange/social-cost-carbon, accessed on 20 Dec 2016)

- *val_c_pap* (=**30942**): Value of CO<sub>2</sub> sequestered in CAZ per PAP household over ten year period (*carbon*/*elig_hh*)


```{r gap_plot, echo=FALSE}
#data
comp.df <- read.csv("sg_comp.csv")

#reshape data for easy plotting
comp.df.melt <- melt(comp.df, id="sn")

##plot with opportunity costs, compensation and valuation of compensation provided - without carbon value (top panel)
comp.plot1 <- ggplot(comp.df.melt[c(1,3,4),],
                     aes(variable, value, fill=variable, label=value)) + 
  geom_col(width = 0.5) + theme_bw() + 
  scale_fill_manual(values = c("orange","royalblue","orange")) + 
  theme(legend.position = "none",
        axis.text.x = element_text(size = 11),
        axis.title.y = element_text(size = 14)) + 
  xlab("") + ylab("US$") + 
  scale_x_discrete(limits=c("npv_oc_all","sg_com","cv_com",""), 
                   labels = c("Median HH opportunity \ncosts (NPV)",
                              "Average spend on \ncompensation per HH",
                              "Average value of \ncompensation per HH",""))
comp.plot1 <- comp.plot1 + 
 geom_text(position = position_dodge(0.9), vjust=-0.25)


#plot with carbon value, opportunity costs, compensation and valuation of compensation provided (for inset on top panel)
comp.plot1i <- ggplot(comp.df.melt[c(10,1,3,4),], 
                     aes(variable, value, fill=variable, label=value)) + 
  geom_col(width = 0.5) + theme_bw() + 
  scale_fill_manual(values = c("orange","royalblue","orange","darkgreen")) + 
  theme(legend.position = "none",
        axis.text = element_text(size = 7)) + 
  xlab("") + ylab("US$") + 
  scale_x_discrete(limits=c("val_c_pap","npv_oc_all","sg_com","cv_com"), 
                   labels = c("Carbon value \nof REDD+ project, \nper household affected",
                              "Median HH opportunity \ncosts (NPV)",
                              "Average spend on \ncompensation per HH",
                              "Average value of \ncompensation per HH"))

comp.plot1i <- comp.plot1i + geom_text(position = position_dodge(0.9), vjust=-0.1)


## plot with eligible households, households identified as PAPs, households receiving compensation and those fully compensated (bottom panel)
hh.plot1 <- ggplot(comp.df.melt[5:8,], 
                    aes(variable, value, fill=variable, label=value)) + 
  geom_col(width = 0.5) + theme_bw() + 
  scale_fill_manual(values = c("orange","royalblue","royalblue","orange")) + 
  theme(legend.position = "none",
        axis.text = element_text(size = 11),
        axis.title.y = element_text(size = 14)) + 
  xlab("") + ylab("Number of HHs") + 
  scale_x_discrete(labels = c("HHs with opportunity \ncosts greater than\nUS$120 (annualised)",
                              "HHs identified \nto receive compensation",
                              "HHs who received\ncompensation",
                              "HHs fully \ncompensated"))

hh.plot1 <- hh.plot1 + geom_text(position = position_dodge(0.9), vjust=-0.25)

##for inset
require(grid)
vp1 <- viewport(width = 0.55, 
                height = 0.36,
                x = 0.71,
                y = 0.81)

##pdf output with inset
pdf("occvhh_panel_carbon_inset.pdf", width = 10, height = 10) 

pushViewport(viewport(layout = grid.layout(2, 1)))

vplayout <- function(x, y) 
  viewport(layout.pos.row = x, layout.pos.col = y)

print(comp.plot1, vp = vplayout(1, 1)) 
print(hh.plot1, vp = vplayout(2, 1))
print(comp.plot1i, vp = vp1)
dev.off()

```

##Comparing opportunity costs estimates with contingent valuation data for the safeguard followup sample
This analysis is based on the opportunity costs estimated for the 62 households in the safeguard followup sample based on their socio-economic characteristics and their distance to CAZ boundary (determinants in the CE model). 
[**Note**: education data is missing for part of the sample at present so this estimation uses *Education*=0 (i.e., assuming all have low level of education). This will be rectified once the missing education data is collected in January 2017.]

```{r sgfollow_data, echo=FALSE}
occv.df <- read.csv("sgf_oc_cv.csv")

#change sign of oc.cens
occv.df$ocest <- -1*occv.df$oc.cens
#get cv value as proportion of opportunty costs
occv.df$cvpcoc <- occv.df$cv_usd/occv.df$ocest

#plot oc vs cv
occv.plot <- ggplot(occv.df, aes(x=ocest, y=cvpcoc)) + 
  geom_point() + theme_bw() + 
  #scale_size("Distance to PA boundary (km) \n(negative values=inside PA)",
             #range = c(0.5,5),
             #breaks=c(-3,-2,-1,0,1,2,3)) +
  coord_cartesian(ylim = c(-.02,.5)) + 
  scale_y_continuous(labels = scales::percent) + 
  xlab("NPV of opportunity costs estimate (US$)") + 
  ylab("Respondent's valuation of the compensation project as % of opportunity costs") +  
  geom_smooth() + 
  theme(axis.title = element_text(size = 14),
        axis.text = element_text(size = 12))#,
        #legend.position=c(.85,.8),
        #legend.background = element_rect(colour = "black"))

#plot output as pdf
pdf("occv_plot.pdf", width = 11, height = 8)
print(occv.plot)
dev.off()

```



## CAZ population estimates
### Prepare data
```{r cazpop_data, echo=FALSE}
#load csv as a df
caz.pop <- read.csv("caz_pop.csv")
#reshape data for easy analysis
cazpop.melt <- melt(caz.pop, id.vars = c("aois", "p4ges"))
```

### Fit linear models to check the best fit set
```{r pop_fits, echo=FALSE}
#LS07 vs P4ges
fit1 <- lm(formula = ls07~p4ges, data = caz.pop)
summary(fit1)
#Fokontany-level data (2010) vs P4ges
fit2 <- lm(formula = fkt2010~p4ges, data = caz.pop)
summary(fit2)

```

### Plot both datasets against P4ges with fitted line
I've just used the labelling to show the adjusted R<sup>2</sup> from the models above.

```{r plot, echo=FALSE}
cazpop.plot <- ggplot(cazpop.melt, aes(x=p4ges, y=value, colour=variable)) + 
  geom_point() +
  geom_smooth(method="lm") + 
  xlab("\nPopulation data collected from P4ges field sites") + 
  ylab("Distributed population data in P4ges field sites\n") +
  scale_colour_discrete(name="Population data distributed (vs P4ges field data)\n",
                        labels=c(ls07 = expression(paste(" LS07 (Adj. ",R^2,"=0.80)")),
                                 fkt2010 = expression(paste(" Fokontany 2010 (Adj. ",R^2,"=0.18)")))) +
  theme_bw() + 
  theme(legend.position=c(.30,.90),
        legend.background = element_rect(colour = "black"),
        legend.title = element_text(size = 16),
        legend.text=element_text(size = 16),
        legend.text.align = 0,
        axis.title = element_text(size = 18),
        axis.text = element_text(size = 12),
        axis.line.x = element_line(colour = "black"),
        axis.line.y = element_line(colour = "black"))

pdf("caz_pop.pdf", width = 10, height = 7)
print(cazpop.plot)
dev.off()

```

## Supplementary(?) plot on land access
This uses data on the number of each type of plots that households have access to, and how they gained access to those plots in order to get a summary on how households in each of our study sites gain access to the land.

### Land Data
```{r land_data, echo=FALSE}
##land holding
cland <- read.csv("land.csv")
##missing
cland[cland==-98] <- NA
str(cland)
##subsetting required variables
land.df <- subset(cland, select = c(1:4,6,8,10,13:14,17))
str(land.df)

##defining land type
land.type <- c("Tavy", "Tavy", "Tanimbary", "Tanimboly", "Other")
land.df$plot_type <- as.factor(land.type[land.df$plot_type])

##defining land ownership
ownship.type <- c("Inherited", "Rented", "Bought", "Borrowed", "Cleared", "Other")
land.df$plot_ownership <- as.factor(ownship.type[land.df$plot_ownership])

##site order
site.org <- c("Ampahitra","Sahavazina","Amporoforo","Mantadia","Zahamena")
site.order <- c("1,REDD+ project\nwith safeguard","2,REDD+ project\nwithout safeguard","Amporoforo (Gradient)","3,Established PA\n(Zahamena)","4,Established PA\n(Mantadia)")
land.df$site <- factor(land.df$site, levels = site.org, labels = site.order)
```

### Land data preparation for plotting
```{r land_dataprep, echo=FALSE, include=FALSE}
land.df$exists <- 1

land.test <- tbl_df(land.df %>% filter(!is.na(plot_type), plot_type!="Other", plot_ownership!="Other"))

land.df.sparse <- land.test %>%
    xtabs(formula = sn ~ resp_id + plot_type + plot_ownership + site) %>%
        as.data.frame()

land.df.sparse$Freq <- ifelse(land.df.sparse$Freq==0, 0, 1)

land.df.summary <- land.df.sparse %>%
    filter(!is.na(plot_type), plot_type!="Other",
                                   plot_ownership!="Other") %>%
    group_by(resp_id) %>%
        mutate(count1=n()) %>%
            group_by(resp_id, site, plot_type, plot_ownership) %>%
                mutate(count2=sum(Freq), prop=count2/count1) %>%
                    group_by(site, plot_type, plot_ownership) %>%
                        summarize(mean_prop=mean(prop), sd_prop=sd(prop), n=n()) %>%
                        mutate(CI=sd_prop/sqrt(n)*1.96, LL=mean_prop-CI,
                               UL=mean_prop+CI)

#without plot_type grouping (but keeping site groupings)
land.test2 <- tbl_df(land.df %>% filter(!is.na(plot_type), 
                                        !is.na(plot_ownership), 
                                        plot_ownership!="Other"))
land.test2.sparse <- land.test2 %>%
    xtabs(formula = sn ~ resp_id + plot_ownership + site) %>%
        as.data.frame()

land.test2.sparse$Freq <- ifelse(land.test2.sparse$Freq==0, 0, 1)

land.all <- land.test2.sparse %>%
    filter(plot_ownership!="Other") %>%
    group_by(resp_id) %>%
        mutate(count1=n()) %>%
            group_by(resp_id, site, plot_ownership) %>%
                mutate(count2=sum(Freq), prop=count2/count1) %>%
                    group_by(site, plot_ownership) %>%
                        summarize(mean_prop=mean(prop), sd_prop=sd(prop), n=n()) %>%
                        mutate(CI=sd_prop/sqrt(n)*1.96, LL=mean_prop-CI,
                               UL=mean_prop+CI)

land.all <- land.all %>%
    group_by(site) %>%
        mutate(sumprop=sum(mean_prop), mean_prop=mean_prop/sumprop,
               LL=LL/sumprop, UL=UL/sumprop)

land.all$Ownership <- factor(land.all$plot_ownership,
                             levels = c("Inherited","Cleared","Bought","Rented","Borrowed"))

```

### Plotting land data

```{r land_access, echo=FALSE}
##grouped by sites (ONLY CE SITES)
land.plot.ce <- land.all %>% filter(is.na(Ownership)==F, site!="Amporoforo (Gradient)") %>% 
  ggplot(aes(site, mean_prop, fill=Ownership)) +
    geom_bar(position=position_dodge(0.9), stat="identity") +
        geom_errorbar(aes(ymin=LL, ymax=UL),
                position=position_dodge(0.9), width=0.2) + 
        theme_bw() + xlab(NULL) + ylab("Proportion of plots\n") + 
  theme(text=element_text(size=20), 
                axis.text.x=element_text(size=16, face = "bold", colour = "black"), 
                axis.text.y=element_text(size=16,face= "bold", colour = "black"))
  
land.plot.ce <- land.plot.ce + theme(legend.position="top", 
                    legend.title=element_blank(), 
                    legend.direction = "horizontal")

##as percentage
land.plot.ce <- land.plot.ce + scale_y_continuous(labels = scales::percent) + 
  ylab("Percentage of plots\n")

##pdf output
pdf("land_plot_ce.pdf", width=11, height=8)
print(land.plot.ce)
dev.off()

```

